Процедура ЦентральнаяОбработкаИнтернетЗаказов() Экспорт
	Если НЕ ПроверитьКлючПодсистемыИнтернетЗаказа() Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ДОБАВИТЬКДАТЕ(СостояниеРаботыСистемы.ДатаНачала, МИНУТА, 5) КАК ДатаПроверки
	               |ИЗ
	               |	РегистрСведений.СостояниеРаботыСистемы КАК СостояниеРаботыСистемы
	               |ГДЕ
	               |	СостояниеРаботыСистемы.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияСистемы.ПриемЗаказов)";
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Если Выборка.ДатаПроверки > ТекущаяДата() Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	РСНЗ = РегистрыСведений.СостояниеРаботыСистемы.СоздатьНаборЗаписей();
	РСНЗ.Отбор.Состояние.Установить(Перечисления.СостоянияСистемы.ПриемЗаказов);
	РСНЗ.Прочитать();
	РСНЗ.Очистить();
	Попытка
		РСНЗ.Записать();
	Исключение
		Возврат;
	КонецПопытки;
	
	Сообщить("" + ТекущаяДата() + " Начали загрузку заказов с сайта.");
	
	глОбработкаИнтернетЗаказа.ВыполнитьОбработкуПочты();
	
	Сообщить("" + ТекущаяДата() + " Закончили загрузку заказов с сайта.");
	
	РСНЗ = РегистрыСведений.СостояниеРаботыСистемы.СоздатьНаборЗаписей();
	РСНЗ.Отбор.Состояние.Установить(Перечисления.СостоянияСистемы.ПриемЗаказов);
	РСНЗ.Прочитать();
	РСНЗ.Очистить();
	Попытка
		РСНЗ.Записать();
	Исключение
	КонецПопытки;
КонецПроцедуры

Функция ПроверитьКлючПодсистемыИнтернетЗаказа() Экспорт
	
	СтрокаКлюча = "";
	ОбщийМодуль.ПолучитьХэш(СтрокаКлюча, глНастройкиИнтернетЗаказа.ИмяПользователя);
	ОбщийМодуль.ПолучитьХэш(СтрокаКлюча, глНастройкиИнтернетЗаказа.Пароль);
	
	Если СтрокаКлюча <> Константы.КлючИнтернетЗаказа.Получить() Тогда
		Возврат Ложь;
	КонецЕсли;
	Возврат Истина;
КонецФункции

